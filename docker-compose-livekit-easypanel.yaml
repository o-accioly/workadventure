version: "3.8"

# Variáveis compartilhadas
x-common-env: &common-env
  # Chaves do LiveKit
  LIVEKIT_API_KEY: "${LIVEKIT_API_KEY}"
  LIVEKIT_API_SECRET: "${LIVEKIT_API_SECRET}"
  LIVEKIT_URL: "ws://livekit:7880"
  REDIS_HOST: redis
  REDIS_PORT: 6379

services:
  # --- LIVEKIT SERVER ---
  livekit:
    image: livekit/livekit-server:v1.8.4
    restart: unless-stopped
    # Removemos o comando complexo. O LiveKit vai ler as variáveis abaixo.
    ports:
      - "7880:7880"       # API / Sinalização
      - "7881:7881"       # TCP Fallback
      - "7881:7881/udp"   # WebRTC UDP Principal
      - "50000-50200:50000-50200/udp" # Range WebRTC
    environment:
      # Configuração via ENV (Mais seguro que Command)
      - LIVEKIT_PORT=7880
      - LIVEKIT_RTC_UDP_PORT=7881
      - LIVEKIT_RTC_TCP_PORT=7881
      - LIVEKIT_RTC_PORT_RANGE_START=50000
      - LIVEKIT_RTC_PORT_RANGE_END=50200
      - LIVEKIT_RTC_USE_EXTERNAL_IP=true
      - LIVEKIT_NODE_IP=${LIVEKIT_NODE_IP} # IP do VPS
      - LIVEKIT_REDIS_ADDRESS=redis:6379
      # Truque para injetar a chave via variável
      - LIVEKIT_KEYS=${LIVEKIT_API_KEY}: ${LIVEKIT_API_SECRET}
    depends_on:
      - redis

  # --- EGRESS (GRAVAÇÃO) ---
  egress:
    image: livekit/egress:v1.9.0
    restart: unless-stopped
    privileged: true
    cap_add:
      - SYS_ADMIN
    ports:
      - "8080:8080"
    environment:
      <<: *common-env
      EGRESS_REDIS_URL: redis://redis:6379
      # Configurações do Minio (S3)
      EGRESS_S3_ENDPOINT: http://minio-livekit:9000
      EGRESS_S3_ACCESS_KEY: ${MINIO_ROOT_USER}
      EGRESS_S3_SECRET: ${MINIO_ROOT_PASSWORD}
      EGRESS_S3_BUCKET: livekit-recordings
      EGRESS_S3_FORCE_PATH_STYLE: "true"
      DISABLE_CUDA: "true"
      DISABLE_NVENC: "true"
    depends_on:
      - redis
      - livekit

  # --- MINIO (ARMAZENAMENTO) ---
  minio-livekit:
    image: minio/minio:latest
    restart: unless-stopped
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: "${MINIO_ROOT_USER}"
      MINIO_ROOT_PASSWORD: "${MINIO_ROOT_PASSWORD}"
    volumes:
      - minio_data:/data

  # --- REDIS ---
  redis:
    image: redis:6-alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data

volumes:
  minio_data:
  redis_data:
