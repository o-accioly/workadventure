version: "3.6"

services:
  play:
    # Aqui mantemos o ${VERSION:-master} para ter um valor padrão se falhar
    image: thecodingmachine/workadventure-play:${VERSION:-master}
    restart: unless-stopped
    ports:
      - "3000"
    environment:
      # --- SINTAXE DE PASSAGEM DIRETA (Sem o =valor) ---
      - DEBUG_MODE
      - PUSHER_URL
      - UPLOADER_URL
      - ICON_URL
      - CHAT_URL
      - SECRET_KEY
      - TURN_SERVER
      - TURN_USER
      - TURN_PASSWORD
      - STUN_SERVER
      - JITSI_URL
      - JITSI_PRIVATE_MODE
      - ENABLE_LIVEKIT
      - LIVEKIT_URL
      - LIVEKIT_API_KEY
      - LIVEKIT_SECRET_KEY
      - DISABLE_ANONYMOUS
      - START_ROOM_URL
      - MAX_PER_GROUP
      - ENABLE_CHAT
      - ENABLE_CHAT_UPLOAD
      # --- Variáveis que precisam de definição manual ---
      - API_URL=back:50051
    depends_on:
      - back

  back:
    image: thecodingmachine/workadventure-back:${VERSION:-master}
    restart: unless-stopped
    ports:
      - "8080"
      - "50051"
    environment:
      - FRONT_URL
      - PUSHER_URL
      - PUBLIC_MAP_STORAGE_URL
      - UPLOADER_URL
      - ICON_URL
      - SECRET_KEY
      - ADMIN_API_TOKEN
      - SECRET_JITSI_KEY
      - LIVEKIT_URL
      - LIVEKIT_API_KEY
      - LIVEKIT_SECRET_KEY
      - REDIS_HOST=redis
      - API_URL=back:50051
      - INTERNAL_MAP_STORAGE_URL=http://map-storage:3000
    depends_on:
      - redis
      - map-storage

  map-storage:
    image: thecodingmachine/workadventure-map-storage:${VERSION:-master}
    restart: unless-stopped
    ports:
      - "3000"
    environment:
      - SECRET_KEY
      - PUSHER_URL
      - AUTHENTICATION_STRATEGY=CheckMapStorageUrl
      - API_URL=back:50051
    volumes:
      - map-storage-data:/maps

  redis:
    image: redis:6
    restart: unless-stopped
    volumes:
      - redisdata:/data

volumes:
  redisdata:
  map-storage-data:
