version: "3.8"

# Variáveis compartilhadas para não repetir senhas
x-common-env: &common-env
  # LiveKit Credentials
  LIVEKIT_API_KEY: ${LIVEKIT_API_KEY}
  LIVEKIT_API_SECRET: ${LIVEKIT_API_SECRET}
  LIVEKIT_URL: ws://livekit:7880 # Comunicação interna
  REDIS_HOST: redis
  REDIS_PORT: 6379

services:
  # --- LIVEKIT SERVER ---
  livekit:
    image: livekit/livekit-server:v1.8.4
    restart: unless-stopped
    command: --config-body "keys:\n  ${LIVEKIT_API_KEY}: ${LIVEKIT_API_SECRET}\nport: 7880\nrtc:\n  udp_port: 7881\n  tcp_port: 7881\n  port_range_start: 50000\n  port_range_end: 50200\n  use_external_ip: true\nredis:\n  address: redis:6379"
    ports:
      - "7880:7880"       # API / Sinalização
      - "7881:7881"       # TCP Fallback
      - "7881:7881/udp"   # WebRTC UDP Principal
      - "50000-50200:50000-50200/udp" # Range WebRTC (Ajustado p/ 200 portas)
    environment:
      - LIVEKIT_NODE_IP=${LIVEKIT_NODE_IP} # IP Público do VPS (CRUCIAL)
    depends_on:
      - redis

  # --- EGRESS (GRAVAÇÃO) ---
  egress:
    image: livekit/egress:v1.9.0
    restart: unless-stopped
    # Privilégios necessários para capturar áudio/vídeo do container
    privileged: true
    cap_add:
      - SYS_ADMIN
    ports:
      - "8080:8080"
    environment:
      <<: *common-env
      EGRESS_REDIS_URL: redis://redis:6379
      # Onde salvar as gravações (S3 Minio)
      EGRESS_S3_ENDPOINT: http://minio-livekit:9000
      EGRESS_S3_ACCESS_KEY: ${MINIO_ROOT_USER}
      EGRESS_S3_SECRET: ${MINIO_ROOT_PASSWORD}
      EGRESS_S3_BUCKET: livekit-recordings
      EGRESS_S3_FORCE_PATH_STYLE: "true"
      # Configurações de GPU (Desativadas para VPS padrão)
      DISABLE_CUDA: "true"
      DISABLE_NVENC: "true"
    depends_on:
      - redis
      - livekit

  # --- MINIO (ARMAZENAMENTO S3) ---
  minio-livekit:
    image: minio/minio:latest
    restart: unless-stopped
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000" # API S3
      - "9001:9001" # Console Web
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data:/data

  # --- REDIS (BANCO DE DADOS) ---
  redis:
    image: redis:6-alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data

volumes:
  minio_data:
  redis_data:
